From 537591c31f49a6d99bf17e938e69922f5055fc2a Mon Sep 17 00:00:00 2001
Message-Id: <537591c31f49a6d99bf17e938e69922f5055fc2a.1522313601.git.marcel.ziswiler@toradex.com>
In-Reply-To: <a99a9d5ea634b864261a1785e135295125925773.1522313601.git.marcel.ziswiler@toradex.com>
References: <a99a9d5ea634b864261a1785e135295125925773.1522313601.git.marcel.ziswiler@toradex.com>
From: Marcel Ziswiler <marcel.ziswiler@toradex.com>
Date: Mon, 27 Nov 2017 10:28:35 +0100
Subject: [PATCH 2/2] apalis-tk1: integrate tezi recovery

In case of Tezi recovery do not stop regular auto booting but rather
load the tezi.itb which got put at a fixed offset of 1M from the
regular loadaddr.

Signed-off-by: Marcel Ziswiler <marcel.ziswiler@toradex.com>
---
 board/toradex/apalis-tk1/apalis-tk1.c | 14 +++++++++++++-
 1 file changed, 13 insertions(+), 1 deletion(-)

diff --git a/board/toradex/apalis-tk1/apalis-tk1.c b/board/toradex/apalis-tk1/apalis-tk1.c
index 7058cb3efc..d46ebc329d 100644
--- a/board/toradex/apalis-tk1/apalis-tk1.c
+++ b/board/toradex/apalis-tk1/apalis-tk1.c
@@ -35,7 +35,19 @@ int arch_misc_init(void)
 	if (readl(NV_PA_BASE_SRAM + NVBOOTINFOTABLE_BOOTTYPE) ==
 	    NVBOOTTYPE_RECOVERY) {
 		printf("USB recovery mode, disabled autoboot\n");
-		setenv("bootdelay", "-1");
+		setenv("bootdelay", "-2");
+		setenv("defargs", "pcie_aspm=off user_debug=30");
+		setenv("fdt_high", "");
+		setenv("initrd_high", "");
+		setenv("setup", "setenv setupargs igb_mac=${ethaddr} " \
+			"consoleblank=0 no_console_suspend=1 " \
+			"console=${console},${baudrate}n8 ${memargs}");
+		setenv("teziargs", "rootfstype=squashfs root=/dev/ram quiet " \
+			"autoinstall");
+		setenv("vidargs", "video=HDMI-A-1:640x480-16@60 hotplugfb");
+		setenv("bootcmd", "run setup; setenv bootargs ${defargs} " \
+			"${setupargs} ${vidargs} ${teziargs}; " \
+			"bootm 0x80208000#config@${fdt_module}");
 	}
 
 	/* PCB Version Indication: V1.2 and later have GPIO_PV0 wired to GND */
-- 
2.14.3

