From f57261b186bdddeebd48017c0513a8f1dbd2c8c6 Mon Sep 17 00:00:00 2001
Message-Id: <f57261b186bdddeebd48017c0513a8f1dbd2c8c6.1528150266.git.marcel.ziswiler@toradex.com>
In-Reply-To: <94844e6d143149cf27495ab3a402bb58b36e549c.1528150266.git.marcel.ziswiler@toradex.com>
References: <94844e6d143149cf27495ab3a402bb58b36e549c.1528150266.git.marcel.ziswiler@toradex.com>
From: Marcel Ziswiler <marcel.ziswiler@toradex.com>
Date: Mon, 4 Jun 2018 16:23:13 +0200
Subject: [PATCH 2/2] apalis_t30: integrate tezi recovery

In case of Tezi recovery do not stop regular auto booting but rather
load the tezi.itb which got put at a fixed offset of 1M from the
regular loadaddr.

Signed-off-by: Marcel Ziswiler <marcel.ziswiler@toradex.com>
---
 board/toradex/apalis_t30/apalis_t30.c | 14 +++++++++++++-
 1 file changed, 13 insertions(+), 1 deletion(-)

diff --git a/board/toradex/apalis_t30/apalis_t30.c b/board/toradex/apalis_t30/apalis_t30.c
index 3151078119..f5252c467f 100644
--- a/board/toradex/apalis_t30/apalis_t30.c
+++ b/board/toradex/apalis_t30/apalis_t30.c
@@ -55,7 +55,19 @@ int arch_misc_init(void)
 	if (readl(NV_PA_BASE_SRAM + NVBOOTINFOTABLE_BOOTTYPE) ==
 	    NVBOOTTYPE_RECOVERY) {
 		printf("USB recovery mode, disabled autoboot\n");
-		setenv("bootdelay", "-1");
+		setenv("bootdelay", "-2");
+		setenv("defargs", "pcie_aspm=off user_debug=30");
+		setenv("fdt_high", "");
+		setenv("initrd_high", "");
+		setenv("setup", "setenv setupargs igb_mac=${ethaddr} " \
+			"consoleblank=0 no_console_suspend=1 " \
+			"console=${console},${baudrate}n8 ${memargs}");
+		setenv("teziargs", "rootfstype=squashfs root=/dev/ram quiet " \
+			"autoinstall");
+		setenv("vidargs", "video=HDMI-A-1:640x480-16@60 hotplugfb");
+		setenv("bootcmd", "run setup; setenv bootargs ${defargs} " \
+			"${setupargs} ${vidargs} ${teziargs}; " \
+			"bootm 0x80208000#config@1");
 	}
 
 	return 0;
-- 
2.14.4

